---
title: "New York State COVID-19"
author: "Ed Young"
date: 
output:
  html_document:
    css: styles.css
    highlight: null
    theme: null
  df_print: kable
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      cache = TRUE)
check_load_pkgs <- function() {
     if (!require(tidyverse)) {
          message("installing the 'tidyverse' package")
          install.packages(tidyverse)
     }
     if (!require(ggrepel)) {
          message("installing the 'ggrepel' package")
          install.packages(ggrepel)
     }
     if (!require(lubridate)) {
          message("installing the 'lubridate' package")
          install.packages(lubridate)
     }
     if (!require(EpiEstim)) {
          message("installing the 'EpiEstim' package")
          install.packages(EpiEstim)
     }
     if (!require(RSocrata)) {
          message("installing the 'RSocrata' package")
          install.packages(RSocrata)
     }
     if (!require(knitr)) {
          message("installing the 'knitr' package")
          install.packages(knitr)
     }
     if (!require(sf)) {
          message("installing the 'sf' package")
          install.packages(sf)
     }
     if (!require(tigris)) {
          message("installing the 'tigris' package")
          install.packages(tigris)
     }
     if (!require(usmap)) {
          message("installing the 'usmap' package")
          install.packages(usmap)
     }
     if (!require(tidycensus)) {
          message("installing the 'tidycensus' package")
          install.packages(tidycensus)
     }
     if (!require(albersusa)) {
          message("installing the 'albersusa' package")
          install.packages(albersusa)
     }     
}
check_load_pkgs()
options(tigris_class = "sf")
options(tigris_use_cache = TRUE)

## Download latest NY State data from health.data.ny.gov
## Munge

nys <-
     read.socrata("https://health.data.ny.gov/resource/xdss-u53e.json") %>%
     select(t = test_date,
            I = new_positives,
            C = cumulative_number_of_positives,
            T = total_number_of_tests,
            county) %>%
     mutate(
          t = as.Date(t),
          I = as.integer(I),
          C = as.integer(C),
          T = as.integer(T),
          f = fips("NY", county=county)
     ) %>%
     arrange(f, t)
nysCounty1 <- nys %>%
     group_by(county) %>%
     filter(max(I) > 100)
nysCounty2 <- nys %>%
     group_by(county) %>%
     filter(max(I) > 10 & max(I) <=100) 
nysCounty3 <- nys %>%
     group_by(county) %>%
     filter(max(I) <= 10)
state <- nys %>%
     group_by(t) %>%
     summarise(SI = sum(I),
               SC = sum(C),
               ST = sum(T))

## Download latest national data at State level from New York Times
## Munge

Cases <-
     read.csv(
          "https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv",
          header = TRUE,
          sep = ","
     ) %>%
     filter(fips<60) %>%
     mutate(
          date = as.Date(date),
          state = as.character(state),
          f = as.character(as.numeric(fips))
     ) %>%
     arrange(f, date) %>%
     as_tibble()
Cases2 <- Cases %>%
     select(f, date, cases) %>%
     arrange(f, date) %>%
     group_by(f) %>%
     mutate(I = if_else(cases - lag(cases, n = 1, default = 0)>0, 
                        cases - lag(cases, n = 1, default = 0), 
                        0)) %>%
     ungroup()

## Download data on deaths at County level from NY Times
## Munge

USDeaths <-
     read.csv(
          "https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv",
          header = TRUE,
          sep = ","
     ) %>%
     mutate(
          date = as.Date(date),
          county = as.character(county),
          state = as.character(state)
     ) %>%
     as_tibble()
NYDeaths <- USDeaths %>%
     filter(state == "New York") %>%
     select(date, deaths) %>%
     group_by(date) %>%
     summarise(SD = sum(deaths)) %>%
     mutate(d = SD - lag(SD, n = 1, default = 0))
NYCountyDeaths <- USDeaths %>%
     filter(state == "New York") %>%
     select(county, date, deaths) %>%
     group_by(county) %>%
     arrange(county, date) %>%
     mutate(d = deaths - dplyr::lag(deaths, n = 1, default = 0)) %>%
     ungroup()
NYCountyDeaths1 <- NYCountyDeaths %>%
     group_by(county) %>%
     filter(max(d) > 100 & county != "Unknown")
NYCountyDeaths2 <- NYCountyDeaths %>%
     group_by(county) %>%
     filter(max(d) > 10 & max(d) <= 100)
NYCountyDeaths3 <- NYCountyDeaths %>%
     group_by(county) %>%
     filter(max(d) <= 10)

## Download US State map

United_States_map <- states() %>%
     filter(STATEFP<60) %>%
     mutate(f = as.character(as.numeric(STATEFP))) %>%
     select(f, STUSPS)
     
## Download New York County map data

ny_map <- counties(state = 36)
ny_map <- cbind(ny_map, st_coordinates(st_centroid(ny_map$geometry))) %>% 
     mutate(f=paste0(ny_map$STATEFP, ny_map$COUNTYFP)) %>%
     select(GEOID, County = NAME, X, Y, f) 


## Download census data
## Munge

NYpop <-
     get_acs(geography = "county",
             state = "NY",
             variables = "B01003_001")
NYpop$NAME <-
     str_replace(NYpop$NAME, "(.*) County, New York", "\\1")
NYpop <- NYpop %>% select(GEOID, county = NAME, estimate)

USpop <-
     get_acs(geography = "state",
             variables = "B01003_001") %>%
     filter(GEOID<60) %>%
     mutate("f" = as.character(as.numeric(GEOID))) %>%
     select(f,
	"State" = NAME,
     	"Population" = estimate)



## Calculate Rt using the EpiEstim Package for New York State 
## The window for estimating Rt can be adjusted using t_start and t_end.
## The default setting for the window is 7 days

t_start <- seq(2, nrow(state) - 3)
t_end <- seq(5, nrow(state))
R.instantaneous <- estimate_R(state$SI,
                              method = "parametric_si",
                              config = list(mean_si = 3.96,
                                            std_si = 4.75))

###### Setup for estimating Rt

## 1. Start with a data.frame that has the following columns: fips, date, incidence
## 2. Obtain the unique list of fips (lof) for which you want to calculate Rt
## 3. Iterate over the list of fips, obtain the list of incidence for each fips
## 4. Use the estimate_R function to estimate R and it's std for each fips
## 5. Assign those values to an ROutput data.frame


makeRoutput <- function(df) {
     lof <- df %>% select(f) %>% unique() %>% filter(!is.na(f)) %>% as.list()
     ROutput <- tibble(f=lof$f, 
                       R = 0, 
                       Std = "")
     for (fips in lof$f) {
          x <- df %>% filter(f==fips, !is.na(I)) %>% select(I) %>% sum()
          y <- df %>% filter(f==fips, !is.na(I)) %>% select(I) %>% lengths()
          if (x * 7 / y > 11) {
               R0 <- estimate_R(
                    incid = df %>% filter(f==fips, !is.na(I)) %>% select(I),
                    method = "parametric_si",
                    config = list(mean_si = 3.96,
                                  std_si = 4.75)
               )
               n <- length(R0$R$t_start)
               std <- round(R0$R$'Std(R)'[n], 3)
               R <- round(R0$R$'Mean(R)'[n], 3)
               ROutput$R[ROutput$f == fips] <- R
               ROutput$Std[ROutput$f == fips] <-
                    sprintf("(%.3f - %.3f)",
                              R - 1.96 * std / sqrt(n),
                              R + 1.96 * std / sqrt(n))
          } else {
               ROutput$R[ROutput$f == fips] <- NA
               ROutput$Std[ROutput$f == fips] <- NA
          }
     }
     return(ROutput)
}


ROutput <- makeRoutput(nys)
ROutput.US <- makeRoutput(Cases2)

# Joining data from Map, Census, and Rt estimation

ny_map3 <- ny_map %>%
     inner_join(ROutput, by = "f") %>%
     inner_join(NYpop, by = "GEOID") 

ny_map4 <- ny_map3 %>%
     as_tibble() %>%
     arrange(desc(R)) %>%
     select(
          County,
          "R<sub>t</sub>" = R,
          "95% Confidence Interval" = Std,
          "Population" = estimate
     )

us_map <- ROutput.US %>%
     inner_join(United_States_map, by = "f") %>%
     inner_join(USpop, by = "f")

us_map48 <- us_map %>%
	 filter(!(State %in% c("Alaska", "District of Columbia", "Hawaii", "Puerto Rico")))

us_map4 <- us_map %>%
     as_tibble() %>%
     arrange(desc(R)) %>%
     select(
          State,
          "R<sub>t</sub>" = R,
          "95% Confidence Interval" = Std,
          Population
     )
```


This page is based on data from <a aria-describedby="footnote-label" href="#D1">New York State Department of Health</a>, most recently updated on `r max(nys$t)`; and on data from <a aria-describedby="footnote-label" href="#D2">The New York Times</a>, most recently updated on `r max(NYDeaths$date)`.

The first set of graphs represent new cases of COVID-19 in the state of New York.

Because of the latency from time of infection to symptoms, and then to diagnosis, it may take up to 14 days after a change in policy for the number of new cases to decrease.  I have indicated that two week period after the policy of social distancing enforcement with gray dots.  Regression lines before and after the policy omit that two week period. 


# New York State New Cases
```{r NYS New}
ggplot(data = state) +
  geom_point(mapping = aes(x = t, y = SI)) +
  geom_label_repel(
    data = filter(state, t == max(t)),
    aes(
      x = t,
      y = SI,
      label = sprintf("%i", SI)
    ),
    segment.color = "black",
    nudge_x = -10,
    nudge_y = 50
  ) +
  labs(x = "Date",
       y = "New Cases per Day") +
  geom_vline(xintercept = as.Date("2020-03-20"), linetype = 4) +
  geom_rect(
    aes(
      xmin = as.Date("2020-03-20"),
      xmax = as.Date("2020-04-03"),
      ymin = 0,
      ymax = Inf
    ),
    fill = "gray100",
    alpha = 0.01
  ) +
  geom_label(label = "Social Distancing Enforced",
             x = as.Date("2020-03-20"),
             y = max(state$SI)) +
  theme(
    plot.background = element_rect(fill = "linen"),
    panel.background = element_rect(fill = "linen"),
    axis.line = element_line(color = "black")
  ) +
  ggtitle(label = "New Cases - Natural Scale")

ggplot(data = state) +
  geom_point(mapping = aes(x = t, y = SI)) +
  geom_rect(
    aes(
      xmin = as.Date("2020-03-20"),
      xmax = as.Date("2020-04-03"),
      ymin = 0,
      ymax = Inf
    ),
    fill = "gray100",
    alpha = 0.01
  ) +
  geom_label_repel(
    data = filter(state, t == max(t)),
    aes(
      x = t,
      y = SI,
      label = sprintf("%i", SI)
    ),
    segment.color = "black",
    nudge_x = -10,
    nudge_y = 50
  ) +
  labs(x = "Date",
       y = "New Cases per Day") +
  scale_y_log10() +
  geom_vline(xintercept = as.Date("2020-03-20"), linetype = 4) +
  geom_label(label = "Social Distancing Enforced",
             x = as.Date("2020-03-20"),
             y = 0) +
  geom_smooth(
    data = filter(state, t <= as.Date("2020-03-20")),
    mapping = aes(x = t, y = SI),
    colour = "red",
    method = lm,
    se = FALSE
  ) +
  geom_smooth(
    data = filter(state, t >= as.Date("2020-04-03")),
    mapping = aes(x = t, y = SI),
    colour = "green",
    method = lm,
    se = FALSE
  ) +
  theme(
    plot.background = element_rect(fill = "linen"),
    panel.background = element_rect(fill = "linen"),
    axis.line = element_line(color = "black")
  ) +
  ggtitle(label = "New Cases - Log Scale")
```

\pagebreak

# New York State Cummulative Cases

```{r NYS Cummulative}
ggplot(data = state) +
  geom_point(mapping = aes(x = t, y = SC)) +
  geom_rect(
    aes(
      xmin = as.Date("2020-03-20"),
      xmax = as.Date("2020-04-03"),
      ymin = 0,
      ymax = Inf
    ),
    fill = "gray100",
    alpha = 0.01
  ) +
  geom_label_repel(
    data = filter(state, t == max(t)),
    aes(
      x = t,
      y = SC,
      label = sprintf("%i", SC)
    ),
    segment.color = "black",
    nudge_x = -10,
    nudge_y = 2
  ) +
  labs(x = "Date",
       y = "Log Scale of Cummulative Cases") +
  scale_y_log10(breaks = c(10, 100, 1000, 10000, 100000)) +
  geom_vline(xintercept = as.Date("2020-03-20"), linetype = 4) +
  geom_label(label = "Social Distancing Enforced",
             x = as.Date("2020-03-20"),
             y = 1) +
  theme(
    plot.background = element_rect(fill = "linen"),
    panel.background = element_rect(fill = "linen"),
    axis.line = element_line(color = "black")
  )
```

\pagebreak

# New York State Percentage of Tests that were Positive

The raw number of positive tests per day can vary depending on how many tests were performed on that day.  One way to normalize this variation is to look at the percentage of tests performed that were positive rather than the raw number of positive tests.

```{r NYS Percentage}
ggplot(data = state) +
  geom_point(mapping = aes(x = t, y = SI * 100 / ST)) +
  geom_rect(
    aes(
      xmin = as.Date("2020-03-20"),
      xmax = as.Date("2020-04-03"),
      ymin = 0,
      ymax = Inf
    ),
    fill = "gray100",
    alpha = 0.01
  ) +
  geom_smooth(mapping = aes(x = t, y = SI * 100 / ST)) +
  geom_label_repel(
    data = filter(state, t == max(t)),
    aes(
      x = t,
      y = SI * 100 / ST,
      label = sprintf("%.1f %%", SI * 100 / ST)
    ),
    segment.color = "black",
    nudge_x = -20,
    nudge_y = 50
  ) +
  geom_ribbon(aes(
    ymin = 0,
    ymax = ST / 500,
    x = t,
    fill = ST
  ),
  alpha = 0.3,
  fill = "tomato") +
  scale_y_continuous(sec.axis = sec_axis(~ . * 500, name = "Total Tests Performed")) +
  geom_vline(xintercept = as.Date("2020-03-20"), linetype = 4) +
  geom_label(label = "Social Distancing Enforced",
             x = as.Date("2020-03-20"),
             y = 100) +
  labs(x = "Date",
       y = "Percentage of Tests Performed that were Positive") +
  theme(
    axis.title.y.left = element_text(color = "blue"),
    axis.title.y.right = element_text(color = "tomato"),
    axis.text.y.right = element_text(color = "tomato"),
    panel.background = element_rect(fill = "linen"),
    plot.background = element_rect(fill = "linen"),
    axis.line.x = element_line(color = "black"),
    axis.line.y.left = element_line(color = "black"),
    axis.line.y.right = element_line(color = "tomato")
  ) 
```
\pagebreak

# Deaths in New York State

```{r NYS Deaths}
ggplot(data = NYDeaths) +
     geom_point(mapping = aes(x = date, y = d)) +
     geom_label_repel(
          data = filter(NYDeaths, date == max(date)),
          aes(
               x = date,
               y = d,
               label = sprintf("%i", d)
          ),
          segment.color = "black",
          nudge_x = -10,
          nudge_y = 2
     ) +
     geom_smooth(mapping = aes(x = date, y = d),
                 method = "gam") +
     labs(x = "Date",
          y = "Deaths") +
     theme(
          plot.background = element_rect(fill = "linen"),
          panel.background = element_rect(fill = "linen"),
          axis.line = element_line(color = "black")
     ) +
     ggtitle(label = "Deaths per Day - Natural Scale")
ggplot(data = NYDeaths) +
     geom_point(mapping = aes(x = date, y = SD)) +
     scale_y_log10() +
     geom_label_repel(
          data = filter(NYDeaths, date == max(date)),
          aes(
               x = date,
               y = SD,
               label = sprintf("%i", SD)
          ),
          segment.color = "black",
          nudge_x = -10,
          nudge_y = 2
     ) +
     labs(x = "Date",
          y = "Deaths") +
     theme(
          plot.background = element_rect(fill = "linen"),
          panel.background = element_rect(fill = "linen"),
          axis.line = element_line(color = "black")
     ) +
     ggtitle(label = "Cummulative Deaths - Log Scale")
```

# Estimation of R~t~ in New York State as a whole

Transmissibility of a virus during an epidemic can be measured by the reproduction number R<sub>t</sub>, the average number of secondary infections caused by a primary infected <a aria-describedby="footnote-label" href="#R"> individual</a>.  Statistical methods to estimate R<sub>t</sub> have been developed which require only case incidence data and the distribution of the serial interval (the time between the onset of symptoms in the primary case and the onset of symptoms in the secondary cases). The distribution of the serial interval (mean and standard deviation) can be estimated by directly interviewing people who have been <a aria-describedby="footnote-label" href="#SI">infected</a>.  So long as some new infections continue to occur R<sub>t</sub> will be greater than 0.  If R<sub>t</sub> is less than 1 (each infected individual causes less than one other person to become infected, on average), we would expect the number of new cases each day to be less than the day before.  If R<sub>t</sub> is greater than 1, we would expect the number of new cases to grow.  

The estimate of the most recent R<sub>t</sub> is <b> `r round(R.instantaneous$R$'Mean(R)'[length(R.instantaneous$R$t_start)], 3)` </b>
The 95% Confidence interval around this estimate is quite narrow, and can't be seen clearly given the scale of the graph.  A Histogram of the estimates of R<sub>t</sub> at the most recent point is given below.

```{r NYS R Plot}
estimate_R_plots(
     R.instantaneous,
     what = "R",
     options_R = list(xlab = "Days Since First Reported Infection"),
     legend = TRUE
)

R.sample <-
sample_posterior_R(R.instantaneous,
n = 1000,
window = length(R.instantaneous$R$t_start))
hist(R.sample)
```
\pagebreak

# Number of New Cases by County

```{r County New 1,  fig.height=20, fig.width=20}
ggplot(data = nysCounty1) +
     geom_point(mapping = aes(x = t, y = I)) +
  geom_rect(
    aes(
      xmin = as.Date("2020-03-20"),
      xmax = as.Date("2020-04-03"),
      ymin = 0,
      ymax = Inf
    ),
    fill = "gray100",
    alpha = 0.01
  ) +  
     labs(x = "Date",
          y = "New Cases per Day") +
     scale_y_log10() +
     geom_vline(xintercept = as.Date("2020-03-20"), linetype = 4) +
     geom_label_repel(
          data = filter(nysCounty1, t == max(t)),
          aes(
               x = t,
               y = I,
               label = sprintf("%i", I)
          ),
          segment.color = "black",
          nudge_x = -10,
          nudge_y = 500
     ) +
     facet_wrap(~ county, ncol = 4) +
     theme(
          plot.background = element_rect(fill = "linen"),
          panel.background = element_rect(fill = "linen"),
          strip.background = element_rect(fill = "grey80"),
          strip.text = element_text(color = "black"),
          legend.position = "bottom",
          panel.border = element_rect(
               colour = "black",
               fill = NA,
               size = 1
          ),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank()
     ) +
     ggtitle("Counties with a maximum of over 100 New Cases on a single day")
```

```{r County New 2,  fig.height=30, fig.width=20}
ggplot(data = nysCounty2) +
  geom_point(mapping = aes(x = t, y = I)) +
  geom_rect(
    aes(
      xmin = as.Date("2020-03-20"),
      xmax = as.Date("2020-04-03"),
      ymin = 0,
      ymax = Inf
    ),
    fill = "gray100",
    alpha = 0.01
  ) +  
  labs(x = "Date",
       y = "New Cases per Day") +
  geom_vline(xintercept = as.Date("2020-03-20"), linetype = 4) +
  scale_y_log10() +
  geom_label_repel(
    data = filter(nysCounty2, t == max(t)),
    aes(
      x = t,
      y = I,
      label = sprintf("%i", I)
    ),
    segment.color = "black",
    nudge_x = -10,
    nudge_y = 20
  ) +
  facet_wrap( ~ county, ncol = 4) +
  theme(
    plot.background = element_rect(fill = "linen"),
    panel.background = element_rect(fill = "linen"),
    strip.background = element_rect(fill = "grey80"),
    strip.text = element_text(color = "black"),
    legend.position = "bottom",
    panel.border = element_rect(
      colour = "black",
      fill = NA,
      size = 1
    ),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  ggtitle("Counties with a maximum of between 10 and 100 New Cases on a single day")
```

```{r County New 3,  fig.height=20, fig.width=20}
ggplot(data = nysCounty3) +
     geom_point(mapping = aes(x = t, y = I)) +
  geom_rect(
    aes(
      xmin = as.Date("2020-03-20"),
      xmax = as.Date("2020-04-03"),
      ymin = 0,
      ymax = Inf
    ),
    fill = "gray100",
    alpha = 0.01
  ) +  
     labs(x = "Date",
          y = "New Cases per Day") +
     scale_y_continuous(breaks = c(0, 2, 4, 6, 8, 10),
                        limits = c(0, 10)) +
     geom_vline(xintercept = as.Date("2020-03-20"), linetype = 4) +
     geom_label_repel(
          data = filter(nysCounty3, t == max(t)),
          aes(
               x = t,
               y = I,
               label = sprintf("%i", I)
          ),
          segment.color = "black",
          nudge_x = -10,
          nudge_y = 2
     ) +
     facet_wrap(~ county, ncol = 4) +
     theme(
          plot.background = element_rect(fill = "linen"),
          panel.background = element_rect(fill = "linen"),
          strip.background = element_rect(fill = "grey80"),
          strip.text = element_text(color = "black"),
          legend.position = "bottom",
          panel.border = element_rect(
               colour = "black",
               fill = NA,
               size = 1
          ),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank()
     ) +
     ggtitle("Counties with a maximum of less than 10 New Cases on a single day")
```

#  Cummulative Cases by County
```{r County Cummualtive, fig.height=50, fig.width=20}
ggplot(data = nys) +
     geom_point(mapping = aes(x = t, y = C)) +
  geom_rect(
    aes(
      xmin = as.Date("2020-03-20"),
      xmax = as.Date("2020-04-03"),
      ymin = 0,
      ymax = Inf
    ),
    fill = "gray100",
    alpha = 0.01
  ) +  
     geom_label_repel(
          data = filter(nys, t == max(t)),
          aes(
               x = t,
               y = C,
               label = sprintf("%i", C)
          ),
          segment.color = "black",
          nudge_x = -10,
          nudge_y = -4
     ) +
     labs(x = "Date",
          y = "Log Scale of Cumulative Cases") +
     scale_y_log10(breaks = c(1, 10, 100, 1000, 10000)) +
     geom_vline(xintercept = as.Date("2020-03-20"), linetype = 4) +
     facet_wrap(~ county, ncol = 4) +
     theme(
          plot.background = element_rect(fill = "linen"),
          panel.background = element_rect(fill = "linen"),
          strip.background = element_rect(fill = "grey80"),
          strip.text = element_text(color = "black"),
          legend.position = "bottom",
          panel.border = element_rect(
               colour = "black",
               fill = NA,
               size = 1
          ),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank()
     ) 
     
```

# Percentage of Tests performed that were Positive by County

```{r County Percentage, fig.height=50, fig.width=20}
ggplot(data = nys) +
     geom_point(mapping = aes(x = t, y = I * 100 / T)) +
  geom_rect(
    aes(
      xmin = as.Date("2020-03-20"),
      xmax = as.Date("2020-04-03"),
      ymin = 0,
      ymax = Inf
    ),
    fill = "gray100",
    alpha = 0.01
  ) +    
     geom_smooth(mapping = aes(x = t, y = I * 100 / T)) +
     geom_label_repel(
          data = filter(nys, t == max(t)),
          aes(
               x = t,
               y = I * 100 / T,
               label = sprintf("%.1f %%", I * 100 / T)
          ),
          segment.color = "black",
          nudge_x = -10,
          nudge_y = 50
     ) +
     geom_ribbon(aes(ymin = 0,
                     ymax = T / 60,
                     x = t),
                 alpha = 0.3,
                 fill = "tomato") +
     scale_y_continuous(sec.axis = sec_axis(~ . * 60, name = "Total Tests Performed")) +
     geom_vline(xintercept = as.Date("2020-03-20"), linetype = 4) +
     geom_hline(yintercept = 0) +
     labs(x = "Date",
          y = "Percentage of Tests Performed that were Positive") +
     facet_wrap(~ county, ncol = 4) +
     theme(
          plot.background = element_rect(fill = "linen"),
          panel.background = element_rect(fill = "linen"),
          strip.background = element_rect(fill = "grey80"),
          strip.text = element_text(color = "black"),
          legend.position = "bottom",
          axis.text.y.right = element_text(color = "tomato"),
          axis.title.y.right = element_text(color = "tomato"),
          panel.border = element_rect(
               colour = "black",
               fill = NA,
               size = 1
          ),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank()
     )
```
\pagebreak

# Number of Deaths in New York by County. 

New York City deaths are combined from New York, Bronx, Kings, Queens and Richmond counties.

```{r County Deaths 1, fig.height=5, fig.width=20}
ggplot(data = NYCountyDeaths1) +
     geom_point(mapping = aes(x = date, y = d)) +
     geom_label_repel(
          data = filter(NYCountyDeaths1, date == max(date)),
          aes(
               x = date,
               y = d,
               label = sprintf("%i", d)
          ),
          segment.color = "black",
          nudge_x = -10,
          nudge_y = 10
     ) +
     labs(x = "Date",
          y = "Deaths") +
     ylim(0, 1000) +
     facet_wrap( ~ county, ncol = 4) +
     theme(
          plot.background = element_rect(fill = "linen"),
          panel.background = element_rect(fill = "linen"),
          strip.background = element_rect(fill = "grey80"),
          strip.text = element_text(color = "black"),
          legend.position = "bottom",
          panel.border = element_rect(
               colour = "black",
               fill = NA,
               size = 1
          ),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank()
     ) +
     ggtitle("Counties with a maximum of over 100 deaths on a single day")
```

```{r County Deaths 2, fig.height=10, fig.width=20}
ggplot(data = NYCountyDeaths2) +
     geom_point(mapping = aes(x = date, y = d)) +
     geom_label_repel(
          data = filter(NYCountyDeaths2, date == max(date)),
          aes(
               x = date,
               y = d,
               label = sprintf("%i", d)
          ),
          segment.color = "black",
          nudge_x = -10,
          nudge_y = 5
     ) +
     labs(x = "Date",
          y = "Deaths") +
     ylim(0, 100) +
     facet_wrap( ~ county, ncol = 4) +
     theme(
          plot.background = element_rect(fill = "linen"),
          panel.background = element_rect(fill = "linen"),
          strip.background = element_rect(fill = "grey80"),
          strip.text = element_text(color = "black"),
          legend.position = "bottom",
          panel.border = element_rect(
               colour = "black",
               fill = NA,
               size = 1
          ),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank()
     ) +
     ggtitle("Counties with a maximum between 10 and 100 deaths on a single day")
```

```{r County Deaths 3, fig.height=30, fig.width=20}
ggplot(data = NYCountyDeaths3) +
     geom_point(mapping = aes(x = date, y = d)) +
     labs(x = "Date",
          y = "Deaths") +
     scale_y_continuous(breaks = c(0, 2, 4, 6, 8, 10),
                        limits = c(0, 10)) +
     geom_label_repel(
          data = filter(NYCountyDeaths3, date == max(date)),
          aes(
               x = date,
               y = d,
               label = sprintf("%i", d)
          ),
          segment.color = "black",
          nudge_x = -10,
          nudge_y = 2
     ) +
     facet_wrap( ~ county, ncol = 4) +
     theme(
          plot.background = element_rect(fill = "linen"),
          panel.background = element_rect(fill = "linen"),
          strip.background = element_rect(fill = "grey80"),
          strip.text = element_text(color = "black"),
          legend.position = "bottom",
          panel.border = element_rect(
               colour = "black",
               fill = NA,
               size = 1
          ),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank()
     ) +
     ggtitle("Counties with a maximum of 10 or fewer deaths on a single day")
```     

# Estimation of R<sub>t</sub> in New York State by County

Counties with fewer than 11 cases per week, on average, do not have enough data to accurately estimate R<sub>t</sub>.  For those counties, R<sub>t</sub> and the 95% Confidence Interval are listed as NA.  On the map, they are left blank.

```{r Counties R, fig.width=10, fig.height=20}
ny_map4  %>%
     kable()
```

# Map of R<sub>t</sub> in New York State by County

```{r NY Map R, fig.width= 20, fig.height=20}
ggplot(data = ny_map3) +
     geom_sf(aes(fill = R)) +
     scale_fill_stepsn(
          breaks = c(0.5, 1, 1.2, 1.5, 2),
          colours = c("blue",
                      "green",
                      "orange",
                      "deeppink",
                      "magenta",
                      "red")
     ) +
     labs(fill = bquote(R[t])) +
     geom_sf_text(aes(label = County, geometry=geometry)) +
     ylim(40, 46) +
     theme(
          panel.background = element_rect(fill = "linen"),
          rect = element_rect(fill = "linen"),
          plot.background = element_rect(fill = "linen"),
          legend.background = element_rect(fill = "linen"),
          axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank()
     )     
```

# Estimation of R<sub>t</sub> in the United States by State


```{r States R, fig.width=10, fig.height=20}
us_map4  %>%
     kable()
```

# Map of R<sub>t</sub> in the United States

```{r US Map R, fig.width= 20, fig.height=8.4}
ggplot(data = us_map48) +
     geom_sf(aes(fill = R,
                 geometry=geometry)) +
     scale_fill_stepsn(
          breaks = c(0.5, 1, 1.2, 1.5, 2),
          colours = c("blue",
                      "green",
                      "orange",
                      "deeppink",
                      "magenta",
                      "red")
     ) +
     geom_sf_text(aes(label = STUSPS, geometry=geometry)) +
     labs(fill = bquote(R[t])) +
     theme(
          panel.background = element_rect(fill = "linen"),
          rect = element_rect(fill = "linen"),
          plot.background = element_rect(fill = "linen"),
          legend.background = element_rect(fill = "linen"),
          axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank()
     )     
```

\pagebreak

<footer>
  <h2 id="footnote-label">Footnotes</h2>
  <ol>
     <li id=#D1>New York State Department of Health data: https://health.data.ny.gov/resource/xdss-u53e.json </li>
     <li id=#D2>New York Times data: https://github.com/nytimes/covid-19-data </li>
     <li id="R">American Journal of Epidemiology
Vol. 178, No. 9 September 15, 2013
A New Framework and Software to Estimate Time-Varying ReproductionNumbers During Epidemics
  <a href="#R-ref" aria-label="Back to content">+</a></li>
      <li id="SI">Emerging Infectious Disease
Volume 26, Number 6—June 2020
Research Letter
Serial Interval of COVID-19 among Publicly Reported Confirmed Cases 
  <a href="#SI-ref" aria-label="Back to content">+</a></li>
  </ol>
</footer>