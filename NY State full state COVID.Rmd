---
title: 'New York State COVID-19'
author: "Ed Young"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    css: styles.css
    highlight: null
    theme: null
  pdf_document: default
  word_document: default
  df_print: kable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
check_load_pkgs <- function() {
     if (!require(tidyverse)) {
          message("installing the 'tidyverse' package")
          install.packages(tidyverse)
     }
     if (!require(ggrepel)) {
          message("installing the 'ggrepel' package")
          install.packages(ggrepel)
     }
     if (!require(lubridate)) {
          message("installing the 'lubridate' package")
          install.packages(lubridate)
     }
     if (!require(EpiEstim)) {
          message("installing the 'EpiEstim' package")
          install.packages(EpiEstim)
     }
     if (!require(RSocrata)) {
          message("installing the 'RSocrata' package")
          install.packages(RSocrata)
     }
     if (!require(knitr)) {
          message("installing the 'knitr' package")
          install.packages(knitr)
     }
     if (!require(sf)) {
          message("installing the 'sf' package")
          install.packages(sf)
     }
     if (!require(tigris)) {
          message("installing the 'tigris' package")
          install.packages(tigris)
     }
     if (!require(usmap)) {
          message("installing the 'usmap' package")
          install.packages(usmap)
     }
     if (!require(tidycensus)) {
          message("installing the 'tidycensus' package")
          install.packages(tidycensus)
     }
}
check_load_pkgs()
options(tigris_class = "sf")
options(tigris_use_cache = TRUE)
nys <-
     read.socrata("https://health.data.ny.gov/resource/xdss-u53e.json") %>%
     select(t = test_date,
            I = new_positives,
            C = cumulative_number_of_positives,
            T = total_number_of_tests,
            county) %>%
     mutate(
          t = as.Date(t),
          I = as.integer(I),
          C = as.integer(C),
          T = as.integer(T)
     ) %>%
     map_df(rev)
NYdeaths <-
     read.csv(
          "https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv",
          header = TRUE,
          sep = ","
     ) %>%
     mutate(
          date = as.Date(date),
          county = as.character(county),
          state = as.character(state)
     ) %>%
     filter(state == "New York") %>%
     as_tibble()
ny_map <- counties(state = 36)
NYpop <-
     get_acs(geography = "county",
             state = "NY",
             variables = "B01003_001")
NYpop$NAME <-
     str_replace(NYpop$NAME, "(.*) County, New York", "\\1")
NYpop <- NYpop %>% select(GEOID, county = NAME, estimate)
```

## This page is based on <a aria-describedby="footnote-label" href="#D">data</a> from New York State Department of Health, most recently updated on `r max(nys$t)`.

# New York State New Cases
```{r NYS New}
state <- nys %>%
     group_by(t) %>%
     summarise(S = sum(I))
ggplot(data = state) +
     geom_point(mapping = aes(x = t, y = S)) +
     geom_label_repel(
          data = filter(state, t == max(t)),
          aes(
               x = t,
               y = S,
               label = sprintf("%i", S)
          ),
          segment.color = "black",
          nudge_x = -10,
          nudge_y = 50
     ) +
     labs(x = "Date",
          y = "New Cases per Day") +
     geom_vline(xintercept = as.Date("2020-03-20"), linetype = 4) +
     geom_label(label = "Social Distancing Enforced",
                x = as.Date("2020-03-20"),
                y = max(state$S)) +
     theme(
          plot.background = element_rect(fill = "linen"),
          panel.background = element_rect(fill = "linen"),
          axis.line = element_line(color = "black")
     ) +
     ggtitle(label = "New Cases - Natural Scale")

ggplot(data = state) +
     geom_point(mapping = aes(x = t, y = S)) +
     geom_label_repel(
          data = filter(state, t == max(t)),
          aes(
               x = t,
               y = S,
               label = sprintf("%i", S)
          ),
          segment.color = "black",
          nudge_x = -10,
          nudge_y = 50
     ) +
     labs(x = "Date",
          y = "New Cases per Day") +
     scale_y_log10() +
     geom_vline(xintercept = as.Date("2020-03-20"), linetype = 4) +
     geom_label(label = "Social Distancing Enforced",
                x = as.Date("2020-03-20"),
                y = 0) +
     theme(
          plot.background = element_rect(fill = "linen"),
          panel.background = element_rect(fill = "linen"),
          axis.line = element_line(color = "black")
     ) +
     ggtitle(label = "New Cases - Log Scale")
```

\pagebreak

# New York State Cummulative Cases

```{r NYS Cummulative}
state <- nys %>%
     group_by(t) %>%
     summarise(S = sum(C))
ggplot(data = state) +
     geom_point(mapping = aes(x = t, y = S)) +
     geom_label_repel(
          data = filter(state, t == max(t)),
          aes(
               x = t,
               y = S,
               label = sprintf("%i", S)
          ),
          segment.color = "black",
          nudge_x = -10,
          nudge_y = 2
     ) +
     labs(x = "Date",
          y = "Log Scale of Cummulative Cases") +
     scale_y_log10(breaks = c(10, 100, 1000, 10000, 100000)) +
     geom_vline(xintercept = as.Date("2020-03-20"), linetype = 4) +
     geom_label(label = "Social Distancing Enforced",
                x = as.Date("2020-03-20"),
                y = 1) +
     geom_smooth(
          data = filter(state, t <= as.Date("2020-03-20")),
          mapping = aes(x = t, y = S),
          colour = "red",
          method = lm,
          se = FALSE
     ) +
     geom_smooth(
          data = filter(state, t >= as.Date("2020-03-20")),
          mapping = aes(x = t, y = S),
          colour = "green",
          se = FALSE
     ) +
     theme(
          plot.background = element_rect(fill = "linen"),
          panel.background = element_rect(fill = "linen"),
          axis.line = element_line(color = "black")
     )
```

\pagebreak

# New York State Percentage of Tests that were Positive

The raw number of positive tests per day can vary depending on how many tests were performed on that day.  One way to normalize this variation is to look at the percentage of tests performed that were positive rather than the raw number of positive tests.

```{r NYS Percentage}
state <- nys %>%
     group_by(t) %>%
     summarise(I1 = sum(I),
               T1 = sum(T))
ggplot(data = state) +
     geom_point(mapping = aes(x = t, y = I1 * 100 / T1)) +
     geom_smooth(mapping = aes(x = t, y = I1 * 100 / T1)) +
     geom_label_repel(
          data = filter(state, t == max(t)),
          aes(
               x = t,
               y = I1 * 100 / T1,
               label = sprintf("%.1f %%", I1 * 100 / T1)
          ),
          segment.color = "black",
          nudge_x = -20,
          nudge_y = 50
     ) +
     geom_ribbon(aes(
          ymin = 0,
          ymax = T1 / 500,
          x = t,
          fill = T1
     ),
     alpha = 0.3,
     fill = "tomato") +
     scale_y_continuous(sec.axis = sec_axis( ~ . * 500, name = "Total Tests Performed")) +
     geom_vline(xintercept = as.Date("2020-03-20"), linetype = 4) +
     geom_label(label = "Social Distancing Enforced",
                x = as.Date("2020-03-20"),
                y = 100) +
     labs(x = "Date",
          y = "Percentage of Tests Performed that were Positive") +
     theme(
          axis.title.y.left = element_text(color = "blue"),
          axis.title.y.right = element_text(color = "tomato"),
          axis.text.y.right = element_text(color = "tomato"),
          panel.background = element_rect(fill = "linen"),
          plot.background = element_rect(fill = "linen"),
          axis.line.x = element_line(color = "black"),
          axis.line.y.left = element_line(color = "black"),
          axis.line.y.right = element_line(color = "tomato")
     ) 
```
\pagebreak

# Deaths in New York State

```{r NYS Deaths}
state <- NYdeaths %>%
     select(date, deaths) %>%
     group_by(date) %>%
     summarise(S = sum(deaths)) %>%
     mutate(d = S - lag(S, n = 1, default = 0))

ggplot(data = state) +
     geom_point(mapping = aes(x = date, y = d)) +
     geom_label_repel(
          data = filter(state, date == max(date)),
          aes(
               x = date,
               y = d,
               label = sprintf("%i", d)
          ),
          segment.color = "black",
          nudge_x = -10,
          nudge_y = 2
     ) +
     geom_smooth(mapping = aes(x = date, y = d),
                 method = "gam") +
     labs(x = "Date",
          y = "Deaths") +
     theme(
          plot.background = element_rect(fill = "linen"),
          panel.background = element_rect(fill = "linen"),
          axis.line = element_line(color = "black")
     ) +
     ggtitle(label = "Deaths per Day - Natural Scale")
ggplot(data = state) +
     geom_point(mapping = aes(x = date, y = S)) +
     scale_y_log10() +
     geom_label_repel(
          data = filter(state, date == max(date)),
          aes(
               x = date,
               y = S,
               label = sprintf("%i", S)
          ),
          segment.color = "black",
          nudge_x = -10,
          nudge_y = 2
     ) +
     labs(x = "Date",
          y = "Deaths") +
     theme(
          plot.background = element_rect(fill = "linen"),
          panel.background = element_rect(fill = "linen"),
          axis.line = element_line(color = "black")
     ) +
     ggtitle(label = "Cummulative Deaths - Log Scale")
```

# Estimation of R~t~ in New York State as a whole

Transmissibility of a virus during an epidemic can be measured by the reproduction number R<sub>t</sub>, the average number of secondary infections caused by a primary infected <a aria-describedby="footnote-label" href="#R"> individual</a>.  Statistical methods to estimate R<sub>t</sub> have been developed which require only case incidence data and the distribution of the serial interval (the time between the onset of symptoms in the primary case and the onset of symptoms in the secondary cases). The distribution of the serial interval (mean and standard deviation) can be estimated by directly interviewing people who have been <a aria-describedby="footnote-label" href="#SI">infected</a>.  So long as some new infections continue to occur R<sub>t</sub> will be greater than 0.  If R<sub>t</sub> is less than 1 (each infected individual causes less than one other person to become infected, on average), we would expect the number of new cases each day to be less than the day before.  If R<sub>t</sub> is greater than 1, we would expect the number of new cases to grow.  

```{r NYS R Calculations}
state <- nys %>%
     group_by(t) %>%
     summarise(S = sum(I))
t_start <- seq(2, nrow(state) - 3)
t_end <- seq(5, nrow(state))
R.instantaneous <- estimate_R(state$S,
                              method = "parametric_si",
                              config = list(mean_si = 3.96,
                                            std_si = 4.75))
```

The estimate of the most recent R<sub>t</sub> is <b> `r round(R.instantaneous$R$'Mean(R)'[length(R.instantaneous$R$t_start)], 3)` </b>
The 95% Confidence interval around this estimate is quite narrow, and can't be seen clearly given the scale of the graph.  A Histogram of the estimates of R<sub>t</sub> at the most recent point is given below.

```{r NYS R Plot}
estimate_R_plots(
     R.instantaneous,
     what = "R",
     options_R = list(xlab = "Days Since First Reported Infection"),
     legend = TRUE
)

R.sample <-
sample_posterior_R(R.instantaneous,
n = 1000,
window = length(R.instantaneous$R$t_start))
hist(R.sample)
```
\pagebreak

# Number of New Cases by County

```{r County New,  fig.height=30, fig.width=20}
ggplot(data = nys) +
     geom_point(mapping = aes(x = t, y = I)) +
     labs(x = "Date",
          y = "New Cases per Day") +
     geom_vline(xintercept = as.Date("2020-03-20"), linetype = 4) +
     geom_label_repel(
          data = filter(nys, t == max(t)),
          aes(
               x = t,
               y = I,
               label = sprintf("%i", I)
          ),
          segment.color = "black",
          nudge_x = -10,
          nudge_y = 500
     ) +
     facet_wrap(~ county, ncol = 4) +
     theme(
          plot.background = element_rect(fill = "linen"),
          panel.background = element_rect(fill = "linen"),
          strip.background = element_rect(fill = "grey80"),
          strip.text = element_text(color = "black"),
          legend.position = "bottom",
          panel.border = element_rect(
               colour = "black",
               fill = NA,
               size = 1
          ),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank()
     )
```

#  Cummulative Cases by County
```{r County Cummualtive, fig.height=30, fig.width=20}
ggplot(data = nys) +
     geom_point(mapping = aes(x = t, y = C)) +
     geom_label_repel(
          data = filter(nys, t == max(t)),
          aes(
               x = t,
               y = C,
               label = sprintf("%i", C)
          ),
          segment.color = "black",
          nudge_x = -10,
          nudge_y = -4
     ) +
     labs(x = "Date",
          y = "Log Scale of Cumulative Cases") +
     scale_y_log10(breaks = c(1, 10, 100, 1000, 10000)) +
     geom_vline(xintercept = as.Date("2020-03-20"), linetype = 4) +
     geom_smooth(
          data = filter(nys, t <= as.Date("2020-03-20")),
          mapping = aes(x = t, y = C),
          colour = "red",
          method = lm,
          se = FALSE
     ) +
     geom_smooth(
          data = filter(nys, t >= as.Date("2020-03-20")),
          mapping = aes(x = t, y = C),
          colour = "green",
          method = lm,
          se = FALSE
     ) +
     facet_wrap(~ county, ncol = 4) +
     theme(
          plot.background = element_rect(fill = "linen"),
          panel.background = element_rect(fill = "linen"),
          strip.background = element_rect(fill = "grey80"),
          strip.text = element_text(color = "black"),
          legend.position = "bottom",
          panel.border = element_rect(
               colour = "black",
               fill = NA,
               size = 1
          ),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank()
     )
```

# Percentage of Tests performed that were Positive by County

```{r County Percentage, fig.height=30, fig.width=20}
ggplot(data = nys) +
     geom_point(mapping = aes(x = t, y = I * 100 / T)) +
     geom_smooth(mapping = aes(x = t, y = I * 100 / T)) +
     geom_label_repel(
          data = filter(nys, t == max(t)),
          aes(
               x = t,
               y = I * 100 / T,
               label = sprintf("%.1f %%", I * 100 / T)
          ),
          segment.color = "black",
          nudge_x = -10,
          nudge_y = 50
     ) +
     geom_ribbon(aes(ymin = 0,
                     ymax = T / 60,
                     x = t),
                 alpha = 0.3,
                 fill = "tomato") +
     scale_y_continuous(sec.axis = sec_axis(~ . * 60, name = "Total Tests Performed")) +
     geom_vline(xintercept = as.Date("2020-03-20"), linetype = 4) +
     geom_hline(yintercept = 0) +
     labs(x = "Date",
          y = "Percentage of Tests Performed that were Positive") +
     facet_wrap(~ county, ncol = 4) +
     theme(
          plot.background = element_rect(fill = "linen"),
          panel.background = element_rect(fill = "linen"),
          strip.background = element_rect(fill = "grey80"),
          strip.text = element_text(color = "black"),
          legend.position = "bottom",
          axis.text.y.right = element_text(color = "tomato"),
          axis.title.y.right = element_text(color = "tomato"),
          panel.border = element_rect(
               colour = "black",
               fill = NA,
               size = 1
          ),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank()
     )
```
\pagebreak

# Number of Deaths in New York by County. 

New York City deaths are combined from New York, Bronx, Kings, Queens and Richmond counties.

```{r County Deaths Calculations}
NYdeaths1 <- NYdeaths %>%
     select(county, date, deaths) %>%
     group_by(county) %>%
     arrange(county, date) %>%
     mutate(d = deaths - dplyr::lag(deaths, n = 1, default = 0)) %>%
     ungroup()

NYdeaths2 <- NYdeaths1 %>%
     group_by(county) %>%
     filter(max(d) > 100 & county != "Unknown")

NYdeaths3 <- NYdeaths1 %>%
     group_by(county) %>%
     filter(max(d) > 10 & max(d) <= 100)

NYdeaths4 <- NYdeaths1 %>%
     group_by(county) %>%
     filter(max(d) <= 10)
```

```{r County Deaths 1, fig.height=5, fig.width=20}

ggplot(data = NYdeaths2) +
     geom_point(mapping = aes(x = date, y = d)) +
     geom_label_repel(
          data = filter(NYdeaths2, date == max(date)),
          aes(
               x = date,
               y = d,
               label = sprintf("%i", d)
          ),
          segment.color = "black",
          nudge_x = -10,
          nudge_y = 20
     ) +
     labs(x = "Date",
          y = "Deaths") +
     ylim(0, 1000) +
     facet_wrap( ~ county, ncol = 4) +
     theme(
          plot.background = element_rect(fill = "linen"),
          panel.background = element_rect(fill = "linen"),
          strip.background = element_rect(fill = "grey80"),
          strip.text = element_text(color = "black"),
          legend.position = "bottom",
          panel.border = element_rect(
               colour = "black",
               fill = NA,
               size = 1
          ),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank()
     ) +
     ggtitle("Counties with a maximum of over 100 deaths on a single day")
```

```{r County Deaths 2, fig.height=10, fig.width=20}
ggplot(data = NYdeaths3) +
     geom_point(mapping = aes(x = date, y = d)) +
     geom_label_repel(
          data = filter(NYdeaths3, date == max(date)),
          aes(
               x = date,
               y = d,
               label = sprintf("%i", d)
          ),
          segment.color = "black",
          nudge_x = -10,
          nudge_y = 2
     ) +
     labs(x = "Date",
          y = "Deaths") +
     ylim(0, 100) +
     facet_wrap( ~ county, ncol = 4) +
     theme(
          plot.background = element_rect(fill = "linen"),
          panel.background = element_rect(fill = "linen"),
          strip.background = element_rect(fill = "grey80"),
          strip.text = element_text(color = "black"),
          legend.position = "bottom",
          panel.border = element_rect(
               colour = "black",
               fill = NA,
               size = 1
          ),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank()
     ) +
     ggtitle("Counties with a maximum between 10 and 100 deaths on a single day")
```

```{r County Deaths 3, fig.height=30, fig.width=20}
ggplot(data = NYdeaths4) +
     geom_point(mapping = aes(x = date, y = d)) +
     labs(x = "Date",
          y = "Deaths") +
     scale_y_continuous(breaks = c(0, 2, 4, 6, 8, 10),
                        limits = c(0, 10)) +
     facet_wrap( ~ county, ncol = 4) +
     theme(
          plot.background = element_rect(fill = "linen"),
          panel.background = element_rect(fill = "linen"),
          strip.background = element_rect(fill = "grey80"),
          strip.text = element_text(color = "black"),
          legend.position = "bottom",
          panel.border = element_rect(
               colour = "black",
               fill = NA,
               size = 1
          ),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank()
     ) +
     ggtitle("Counties with a maximum of 10 or fewer deaths on a single day")
```     

# Estimation of R<sub>t</sub> in New York State by County

Counties with fewer than 11 cases per week, on average, do not have enough data to accurately estimate R<sub>t</sub>.  For those counties, R<sub>t</sub> and the 95% Confidence Interval are listed as NA.  On the map, they are left blank.

```{r Counties R, fig.width=20, fig.height=20}
NYcounties <- unique(nys$county)
ROutput <- tibble(County = NYcounties, R = 0, Std = "")

RInput <- function(co) {
     return(list(nys$I[nys$county == co]))
}

## produce a list of lists,
## each item is a list of daily incidence by County, labelled by County Name

df4 <- vapply(NYcounties, RInput, list(1))

## Iterate over the list of incidences by county,
## Use the estimate_R function to estimate R and it's std for each county
## Assign those values to the ROutput data.frame

for (Incidence in names(df4)) {
     if (sum(df4[[Incidence]]) * 7 / length(df4[[Incidence]]) > 11) {
          R0 <- estimate_R(
               incid = df4[[Incidence]],
               method = "parametric_si",
               config = list(mean_si = 3.96,
                             std_si = 4.75)
          )
          n <- length(R0$R$t_start)
          std <- round(R0$R$'Std(R)'[n], 3)
          R <- round(R0$R$'Mean(R)'[n], 3)
          ROutput$R[ROutput$County == Incidence] <- R
          ROutput$Std[ROutput$County == Incidence] <-
               sprintf("(%.3f - %.3f)",
                       R - 1.96 * std / sqrt(n),
                       R + 1.96 * std / sqrt(n))
     } else {
          ROutput$R[ROutput$County == Incidence] <- NA
          ROutput$Std[ROutput$County == Incidence] <- NA
     }
}

ny_map2 <-
     cbind(ny_map, st_coordinates(st_centroid(ny_map$geometry))) %>%
     select(GEOID, County = NAME, X, Y) %>%
     mutate(LabelDirection = if_else(X + 75 > 0, "A", "B"))
ny_map3 <- ny_map2 %>%
     inner_join(ROutput, by = "County") %>%
     inner_join(NYpop, by = "GEOID") 

ny_map3 %>%
     as_tibble() %>%
     arrange(desc(R)) %>%
     select(
          County,
          "R<sub>t</sub>" = R,
          "95% Confidence Interval" = Std,
          "Population" = estimate
     ) %>%
     kable()

ggplot(data = ny_map3) +
     geom_sf(aes(fill = R)) +
     scale_fill_stepsn(
          breaks = c(0.5, 1, 1.2, 1.5, 2),
          colours = c("yellow",
                      "green",
                      "seagreen",
                      "orange",
                      "magenta",
                      "red")
     ) +
     labs(fill = bquote(R[t])) +
     geom_text_repel(
          data = filter(ny_map3, R > 0, LabelDirection == "A"),
          mapping = aes(X, Y, label = County),
          size = 4
     ) +
     geom_text_repel(
          data = filter(ny_map3, R > 0, LabelDirection == "B"),
          mapping = aes(X, Y, label = County),
          size = 4
     ) +
     ylim(40, 46) +
     theme(
          panel.background = element_rect(fill = "linen"),
          rect = element_rect(fill = "linen"),
          plot.background = element_rect(fill = "linen"),
          legend.background = element_rect(fill = "linen"),
          axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank()
     )     
```
\pagebreak

<footer>
  <h2 id="footnote-label">Footnotes</h2>
  <ol>
  <li id=#D> https://health.data.ny.gov/resource/xdss-u53e.json </li>
  </ol>
  <ol>
  <li id="R">American Journal of Epidemiology
Vol. 178, No. 9 September 15, 2013
A New Framework and Software to Estimate Time-Varying ReproductionNumbers During Epidemics
  <a href="#R-ref" aria-label="Back to content">+</a>
  </li>
  <li id="SI">Emerging Infectious Disease
Volume 26, Number 6—June 2020
Research Letter
Serial Interval of COVID-19 among Publicly Reported Confirmed Cases 
  <a href="#SI-ref" aria-label="Back to content">+</a>
  </li>
  </ol>
</footer>